{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "grep_plan_v2.schema.json",
  "title": "grep_plan_v2",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema", "intent", "intent_hash", "search"],
  "properties": {
    "schema": {
      "type": "string",
      "const": "grep_plan_v2",
      "description": "Document discriminator for a compiled grep plan (v2)."
    },
    "intent": {
      "description": "The original intent document.",
      "$ref": "grep_intent_v2.schema.json"
    },
    "intent_hash": {
      "type": "string",
      "pattern": "^sha256:[0-9a-f]{64}$",
      "description": "SHA256 hash of normalized intent JSON."
    },
    "search": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "root",
        "content_patterns",
        "file_filters",
        "case",
        "context",
        "format",
        "max_lines",
        "max_files",
        "max_matches",
        "parallelism",
        "policy",
        "limits"
      ],
      "properties": {
        "root": {
          "type": "string",
          "minLength": 1,
          "description": "Root directory for the search."
        },
        "content_patterns": {
          "type": "array",
          "description": "Content patterns to search for (no globs here).",
          "minItems": 1,
          "maxItems": 32,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["kind", "value"],
            "properties": {
              "kind": {
                "type": "string",
                "enum": ["fixed", "regex"],
                "description": "Content match semantics."
              },
              "value": {
                "type": "string",
                "minLength": 1,
                "maxLength": 512,
                "description": "Pattern value."
              }
            }
          }
        },
        "file_filters": {
          "type": "object",
          "description": "File selection filters (globs only).",
          "additionalProperties": false,
          "required": ["include_globs", "exclude_globs"],
          "properties": {
            "include_globs": {
              "type": "array",
              "items": { "type": "string", "minLength": 1, "maxLength": 512 },
              "maxItems": 64
            },
            "exclude_globs": {
              "type": "array",
              "items": { "type": "string", "minLength": 1, "maxLength": 512 },
              "maxItems": 128
            }
          }
        },
        "case": {
          "type": "string",
          "enum": ["sensitive", "insensitive", "smart"],
          "description": "Case behavior."
        },
        "context": {
          "type": "integer",
          "minimum": 0,
          "maximum": 50,
          "description": "Lines of context."
        },
        "format": {
          "type": "string",
          "enum": ["auto", "human", "jsonl"],
          "description": "Output format."
        },
        "max_lines": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100000,
          "description": "Max output lines."
        },
        "max_files": {
          "type": ["integer", "null"],
          "minimum": 1,
          "maximum": 100000,
          "description": "Stop after N files (deterministically)."
        },
        "max_matches": {
          "type": ["integer", "null"],
          "minimum": 1,
          "maximum": 100000,
          "description": "Stop after N total matches."
        },
        "parallelism": {
          "type": "integer",
          "minimum": 1,
          "maximum": 64,
          "description": "Concurrent processes."
        },
        "policy": {
          "type": "object",
          "additionalProperties": false,
          "required": ["hidden", "follow", "no_ignore"],
          "properties": {
            "hidden": { "type": "boolean", "default": false },
            "follow": { "type": "boolean", "default": false },
            "no_ignore": { "type": "boolean", "default": false }
          }
        },
        "limits": {
          "type": "object",
          "description": "Execution limits (fail closed if exceeded).",
          "additionalProperties": false,
          "required": ["max_pattern_length"],
          "properties": {
            "max_pattern_length": {
              "type": "integer",
              "minimum": 1,
              "maximum": 4096,
              "description": "Maximum length for any content pattern."
            }
          }
        }
      }
    }
  }
}

